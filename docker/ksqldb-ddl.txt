SET 'auto.offset.reset' = 'earliest';

CREATE STREAM HOTELS
    WITH (KAFKA_TOPIC='mysql-debezium-h5traveloto.h5traveloto.hotels',
       VALUE_FORMAT='AVRO');

CREATE STREAM HOTEL_FACILITY_DETAILS
    WITH (KAFKA_TOPIC='mysql-debezium-h5traveloto.h5traveloto.hotel_facility_details,
        VALUE_FORMAT='AVRO');

CREATE STREAM ROOM_TYPES
    WITH (KAFKA_TOPIC='mysql-debezium-h5traveloto.h5traveloto.room_types',
       VALUE_FORMAT='AVRO');

CREATE STREAM ROOM_FACILITY_DETAILS
    WITH (KAFKA_TOPIC='mysql-debezium-h5traveloto.h5traveloto.room_facility_details,
        VALUE_FORMAT='AVRO');


CREATE TABLE PROVINCES
    WITH (KAFKA_TOPIC='mysql-debezium-h5traveloto.h5traveloto.hotels',
        VALUE_FORMAT='AVRO');

CREATE TABLE DISTRICTS
    WITH (KAFKA_TOPIC='mysql-debezium-h5traveloto.h5traveloto.districts',
        VALUE_FORMAT='AVRO');


CREATE TABLE WARDS
    WITH (KAFKA_TOPIC='mysql-debezium-h5traveloto.h5traveloto.wards',
        VALUE_FORMAT='AVRO');

CREATE STREAM HOTELS_WITH_FACILITIES AS
SELECT
    h.HOTEL_ID,
    h.HOTEL_NAME,
    h.DESCRIPTION,
    -- other columns from the HOTELS stream
    COLLECT_LIST(f.FACILITY_ID) AS FACILITY_IDS
FROM HOTELS h


CREATE STREAM HOTELS AS
    SELECT
        H.ID,
        H.NAME AS NAME,
        H.TYPE,
        H.LOGO,
        H.IMAGE,
        H.ADDRESS,
        P.NAME AS PROVINCE,
        D.NAME AS DISTRICT,
        W.NAME AS WARD,
        H.LAT,
        H.LNG,
        H.STAR,
        H.STATUS,
        H.CREATED_AT,
        H.UPDATED_AT,
        COLLECT_LIST(f.FACILITY_ID) AS FACILITY_IDS
    FROM HOTELS H
        INNER JOIN PROVINCES P ON 'Struct{code='+H.PROVINCE_CODE+'}' = P.ID
        INNER JOIN DISTRICTS D ON 'Struct{code='+H.DISTRICT_CODE+'}' = D.ID
        INNER JOIN WARDS W ON 'Struct{code='+H.DISTRICT_CODE+'}' = W.ID
        LEFT JOIN HOTEL_FACILITY_DETAILS f
            WITHIN 10 SECONDS
            ON H.ID = f.HOTEL_ID
GROUP BY H.ID
PARTITION BY H.ID;


